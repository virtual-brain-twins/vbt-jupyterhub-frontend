{% macro modal(title, btn_label=None, btn_class="btn-primary") %}
  {% set key = title.replace(' ', '-').lower() %}
  {% set btn_label = btn_label or title %}
  <div class="modal fade"
       id="{{ key }}-dialog"
       tabindex="-1"
       role="dialog"
       aria-labelledby="{{ key }}-label"
       aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="{{ key }}-label">{{ title }}</h2>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">{{ caller() }}</div>
        <div class="modal-footer">
          <button type="button"
                  class="btn {{ btn_class }}"
                  data-bs-dismiss="modal"
                  data-dismiss="modal">{{ btn_label }}</button>
        </div>
      </div>
    </div>
  </div>
{% endmacro %}

<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  {% block meta -%}
  {%- endblock -%}

  <title>{% block title %}Jupyterhub{% endblock %}</title>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta property="og:image" content='{{ static_url("images/mini_website.jpg", include_version=True) }}'>
  <meta property="og:locale" content="en_US">
  <meta property="og:site_name" content="jupyter-jsc">
  <meta property="og:title" content="jupyter-jsc">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://{{frontendCollection.get('hostname')}}{{ base_url|default('', true) }}">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  {% block favicon -%}
  <link rel="icon" href='{{static_url("images/favicon.svg", include_version=True)}}' type="jpg/png" />
  {%- endblock %}

  <link rel="stylesheet" href='{{static_url("components/bootstrap-5.0/dist/css/bootstrap.min.css")}}' type="text/css" />
  <link rel="stylesheet" href='{{static_url("components/font-awesome-4.7.0/css/font-awesome.min.css")}}' type="text/css" />
  <link rel="stylesheet" href='{{static_url("css/base.css")}}' type="text/css" />
  <link rel="stylesheet" href='{{static_url("css/header.css")}}' type="text/css" />
  <link rel="stylesheet" href='{{static_url("css/footer.css")}}' type="text/css" />
  <link rel="stylesheet" href='{{static_url("components/jquery-confirm/jquery-confirm.min.css")}}' />
  {% block stylesheet -%}
  {%- endblock %}

  <script src='{{static_url("components/jquery/dist/jquery.min.js")}}' type="text/javascript" charset="utf-8"></script>
  <script src='{{static_url("components/bootstrap-5.0/dist/js/bootstrap.bundle.min.js")}}' type="text/javascript" charset="utf-8"></script>
  <script src='{{static_url("components/requirejs/require.js")}}' type="text/javascript" charset="utf-8"></script>
  <script src='{{static_url("components/jquery/dist/jquery.min.js")}}'></script>
  <script src='{{static_url("components/jquery-confirm/jquery-confirm.min.js")}}'></script>
  {% block scripts -%}
  {%- endblock %}
  <script>
    var evtSource = undefined;
    var testCounter = 0;
    let globalMaintenanceSystems = [];

    function sseInit() {
      let sseUrl = `${jhdata.base_url}api/sse`
      if ( jhdata.user ) {
          sseUrl = `${jhdata.base_url}api/sse/${jhdata.user}?_xsrf=${window.jhdata.xsrf_token}`;
      }
      if ( evtSource ) {
        evtSource.close();
      }
      evtSource = new EventSource(sseUrl);
      evtSource.onmessage = (e) => {
        try {
          const jsonData = JSON.parse(event.data);
          for (const [key, value] of Object.entries(jsonData)) {
            $(`[data-sse-${key}]`).trigger("sse", value);
          }
        } catch (error) {
            console.error("Failed to parse SSE data:", error);
        }
      };
      evtSource.onerror = (e) => {
        console.log("Reconnect EventSource");
        // Reconnect
      }
    }

    require.config({
      {%- if version_hash -%}
      urlArgs: "v={{version_hash}}",
      {%- endif -%}
      baseUrl: '{{static_url("js", include_version=True)}}',
      paths: {
        components: '../components',
        jquery: '../components/jquery/dist/jquery.min',
        bootstrap: '../components/bootstrap-5.0/dist/js/bootstrap.min',
        moment: "../components/moment/moment",
      },
      shim: {
        bootstrap: {
          deps: ["jquery"],
          exports: "bootstrap"
        },
      }
    });
  </script>
  <script type="text/javascript">
    window.jhdata = {
      base_url: "{{ base_url }}",
      prefix: "{{prefix}}",
      {%- if user %}
      user: "{{user.json_escaped_name}}",
      {%- endif -%}
      {%- if user and user.active %}
      user_active: true,
      {%- else %}
      user_active: false,
      {%- endif -%}
      {%- if admin_access %}
      admin_access: true,
      {%- else %}
      admin_access: false,
      {%- endif -%}
      {%- if not no_spawner_check and user and user.spawner.options_form %}
      options_form: true,
      {%- else %}
      options_form: false,
      {%- endif %}
      {%- if cancel_url %}
      cancel_url: "{{ cancel_url }}",
      {%- endif %}
      xsrf_token: "{{ xsrf_token }}",
    }
  </script>
</head>

<body>
  <noscript>
    <div id='noscript'>
      JupyterHub requires JavaScript.<br>
      Please enable it to proceed.
    </div>
  </noscript>

  <div class="d-flex flex-column h-100">

    {% block nav_bar %}
      <nav class="navbar navbar-expand-sm bg-body-tertiary mb-4">
        <div class="container-fluid">
          {% block logo %}
            <span id="jupyterhub-logo" class="navbar-brand">
              <a href="https://www.virtualbraintwin.eu/" target="_blank">
                <img src='{{ base_url }}/static/images/logo_white.svg'
                     alt='VBT JupyterHub logo'
                     class='jpy-logo'
                     title='Virtual Brain Twin' />
              </a>
            </span>
          {% endblock logo %}
          {% if user %}
            <button class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#thenavbar"
                    aria-controls="thenavbar"
                    aria-expanded="false"
                    aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
          {% endif %}
          <div class="collapse navbar-collapse" id="thenavbar">
            <ul class="navbar-nav me-auto mb-0">
              {% if user %}
                {% block nav_bar_left_items %}
                  <li class="nav-item">
                    <a class="nav-link" href="{{ base_url }}home">Home</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="{{ base_url }}token">Token</a>
                  </li>
                  {% if 'admin-ui' in parsed_scopes %}
                    <li class="nav-item">
                      <a class="nav-link" href="{{ base_url }}admin">Admin</a>
                    </li>
                  {% endif %}
                  {% if services %}
                    <li class="nav-item dropdown">
                      <a href="#"
                         class="nav-link dropdown-toggle"
                         data-bs-toggle="dropdown"
                         role="button"
                         aria-expanded="false">Services</a>
                      <ul class="dropdown-menu">
                        {% for service in services %}
                          {% block service scoped %}
                            <li>
                              <a class="dropdown-item" href="{{ service.href }}">{{ service.name }}</a>
                            </li>
                          {% endblock service %}
                        {% endfor %}
                      </ul>
                    </li>
                  {% endif %}
                {% endblock nav_bar_left_items %}
              {% endif %}
            </ul>
            <ul class="nav navbar-nav me-2">
              {% block nav_bar_right_items %}
                <!-- <li class="nav-item">
                  {% block theme_toggle %}
                    <button class="btn btn-sm"
                            id="dark-theme-toggle"
                            aria-label="Toggle dark mode"
                            title="Toggle dark mode">
                      <i aria-hidden="true" class="fa fa-circle-half-stroke"></i>
                    </button>
                  {% endblock theme_toggle %}
                </li> -->
                <li class="nav-item">
                  {% block login_widget %}
                    <span id="login_widget">
                      {% if user %}
                        <span class="me-1">{{ user.name }}</span>
                        <a id="logout"
                           role="button"
                           class="btn btn-sm btn-outline-contrast"
                           href="{{ logout_url }}"> <i aria-hidden="true" class="fa fa-sign-out"></i> Logout</a>
                      {% else %}
                        <a id="login"
                           role="button"
                           class="btn btn-sm btn-outline-contrast"
                           href="{{ login_url }}">Login</a>
                      {% endif %}
                    </span>
                  {% endblock login_widget %}
                </li>
              {% endblock nav_bar_right_items %}
            </ul>
          </div>
          {% block header %}
          {% endblock header %}
        </div>
      </nav>
    {% endblock nav_bar %}

    {% block announcement %}
      {% if announcement %}
        <div class="container text-center announcement alert alert-warning">{{ announcement | safe }}</div>
      {% endif %}
    {% endblock announcement %}

    {#- MAIN #}
    <main>
    {% block main %}
    {% endblock %}
    </main>

    {#- FOOTER #}
    {% block footer %}
	<footer class="custom-footer">
			<div class="footer-content">
				<div class="footer-left">
					<p>Â© 2025 Virtual Brain Twin</p>
				</div>
				<div class="footer-right">
					<a href="https://ec.europa.eu/info/funding-tenders/opportunities/portal/screen/how-to-participate/org-details/896706219/project/101137289/program/43108390/details" target="_blank">
						<img src="{{ base_url }}static/images/eu_funded_white.png" alt="EU Funded Project">
					</a>
				</div>
			</div>

	</footer>
    {% endblock footer %}
  </div>

  {#- SCRIPTS #}
  <script src='{{static_url("js/logout.js", include_version=True) }}' type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript">
    // Enable tooltips everywhere
    function enableTooltips() {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      })
    }
    $( function() { enableTooltips() });
  </script>
  {% block script -%}
  {%- endblock %}
  <script>
  $(document).ready(function() {
    sseInit();
  });
  window.onbeforeunload = function() {
    if (typeof evtSource !== 'undefined') {
        evtSource.close();
    }
  }
  </script>
</body>
</html>